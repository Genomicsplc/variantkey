// Nicola Asuni

#if __STDC_VERSION__ >= 199901L
#define _XOPEN_SOURCE 600
#else
#define _XOPEN_SOURCE 500
#endif

#include <stdio.h>
#include <string.h>
#include <time.h>
#include "farmhash64.h"

#define TEST_STRING_DATA_SIZE 45

static const int k_test_size = 300;
static const int k_data_size = 1048576; // 1 << 20
static char data[1048576];

typedef struct test_data_string_t
{
    uint32_t h32;
    uint64_t h64;
    const char* str;
} test_data_string_t;

static test_data_string_t string_input[TEST_STRING_DATA_SIZE] =
{
    {0xfe0061e9, 0x9ae16a3b2f90404f, ""},
    {0xd824662a, 0xb3454265b6df75e3, "a"},
    {0x15eb5ed6, 0xaa8d6e5242ada51e, "ab"},
    {0xcaf25fe2, 0x24a5b3a074e7f369, "abc"},
    {0xcf297808, 0x1a5502de4a1f8101, "abcd"},
    {0x5f8d48db, 0xc22f4663e54e04d4, "abcde"},
    {0x16b8a2fd, 0xc329379e6a03c2cd, "abcdef"},
    {0xcfc5f43d, 0x3c40c92b1ccb7355, "abcdefg"},
    {0x8d1b642, 0xfee9d22990c82909, "abcdefgh"},
    {0xb382832e, 0x332c8ed4dae5ba42, "abcdefghi"},
    {0x3f19a3cb, 0xad052244b781c4eb, "0123456789"},
    {0xee83c5c, 0x3ef4c03514208c77, "0123456789 "},
    {0x6fca023f, 0x496841e83a33cc91, "0123456789-0"},
    {0x6b2c02bd, 0xd81bcb9f3679ac0c, "0123456789~01"},
    {0xb8e8fba, 0x5da5a6a117c606f6, "0123456789#012"},
    {0xe6946835, 0x5361eae17c1ff6bc, "0123456789@0123"},
    {0xfa44df74, 0x4283d4ef43627f64, "0123456789'01234"},
    {0x2a1ed264, 0x46a7416ed4861e3b, "0123456789=012345"},
    {0xbcd3277f, 0xa4abb4e0da2c594c, "0123456789+0123456"},
    {0x26bf5a67, 0xcf1c7d3ad54f9215, "0123456789*01234567"},
    {0x8eedb634, 0x07adf50b2ac764fc, "0123456789&012345678"},
    {0xa329652e, 0xdebcba8e6f3eabd1, "0123456789^0123456789"},
    {0x4ba9b4ed, 0x4dbd128af51d77e8, "0123456789%0123456789Â£"},
    {0x1b9ea72f, 0xd78d5f852d522e6a, "0123456789$0123456789!0"},
    {0x819d77a5, 0x80d73b843ba57db8, "size:  a.out:  bad magic"},
    {0x8b72761e, 0x8eb3808d1ccfc779, "Nepal premier won't resign."},
    {0x5f21fe43, 0xb944f8a16261e414, "C is as portable as Stonehedge!!"},
    {0xa15ead04, 0xe8f89ab6df9bdd25, "Discard medicine more than two years old."},
    {0xe3763baf, 0xa9961670ce2a46d9, "I wouldn't marry him with a ten foot pole."},
    {0x50a48aaa, 0xbdd69b798d6ba37a, "If the enemy is within range, then so are you."},
    {0x517e346c, 0xc2f8db8624fefc0e, "The major problem is with sendmail.  -Mark Horton"},
    {0x8a4b0b6c, 0x5a0a6efd52e84e2a, "How can you write a big system without C++?  -Paul Glick"},
    {0xb360937b, 0x786d7e1987023ca9, "He who has a shady past knows that nice guys finish last."},
    {0x2e5713b3, 0x5d14f96c18fe3d5e, "Free! Free!/A trip/to Mars/for 900/empty jars/Burma Shave"},
    {0xec6d1e0e, 0xec8848fd3b266c10, "His money is twice tainted: 'taint yours and 'taint mine."},
    {0x7175f31d, 0x2a578b80bb82147c, "The days of the digital watch are numbered.  -Tom Stoppard"},
    {0xdf4c5297, 0x55182f8859eca4ce, "For every action there is an equal and opposite government program."},
    {0x62359aca, 0xabcdb319fcf2826c, "You remind me of a TV show, but that's all right: I watch it anyway."},
    {0x398c0b7c, 0x1d85702503ac7eb4, "It's well we cannot hear the screams/That we create in others' dreams."},
    {0x47f9c, 0xa2b8bf3032021993, "Give me a rock, paper and scissors and I will move the world.  CCFestoon"},
    {0xe56239a7, 0x38aa3175b37f305c, "It's a tiny change to the code and not completely disgusting. - Bob Manchek"},
    {0xb556f325, 0x7e85d7b050ed2967, "There is no reason for any individual to have a computer in their home. -Ken Olsen, 1977"},
    {0x75cc5362, 0x5a05644eb66e435e, "Even if I could be Shakespeare, I think I should still choose to be Faraday. - A. Huxley"},
    {0xc401a0bf, 0x98eff6958c5e91a, "The fugacity of a constituent in a mixture of gases at a given temperature is proportional to its mole fraction.  Lewis-Randall Rule"},
    {0x4e56b7e9, 0xc3f02c4ffd5d71e6, "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."},
};

static const uint32_t farmhash64_expected[] =
{
    2598464059u, 797982799u, 1410420968u, 2134990486u, 255297188u, 2992121793u, 4019337850u, 452431531u, 299850021u,
    2532580744u, 2199864459u, 3696623795u, 1053458494u, 1882212500u, 458884671u, 3033004529u, 2700149065u, 2699376854u,
    4220361840u, 1712034059u, 594028478u, 2921867846u, 3280331829u, 326029180u, 3824583307u, 1612122221u, 2233466664u,
    1432476832u, 1628777059u, 1499109081u, 1145519619u, 3190844552u, 65721842u, 489963606u, 1790705123u, 2128624475u,
    155445229u, 1672724608u, 3610042449u, 1911523866u, 1099072299u, 1389770549u, 3603803785u, 629449419u, 1552847036u,
    645684964u, 3151491850u, 3272648435u, 916494250u, 1230085527u, 231181488u, 851743255u, 1142264800u, 3667013118u,
    732137533u, 1909203251u, 4072067757u, 4165088768u, 956300927u, 914413116u, 3074915312u, 3117299654u, 1438494951u,
    507436733u, 126024219u, 146044391u, 165589978u, 1578546616u, 249776086u, 1207522198u, 46987739u, 1157614300u,
    3614377032u, 586863115u, 1164298657u, 4140791139u, 3725511003u, 232064808u, 512845449u, 3748861010u, 22638523u,
    648000590u, 1024246061u, 4027776454u, 411505255u, 1973395102u, 3474970689u, 1029055034u, 589567754u, 325737734u,
    257578986u, 3698087965u, 2305332220u, 191910725u, 3315355162u, 2135941665u, 23075771u, 3252374102u, 663013031u,
    3444053918u, 2115441882u, 4081398201u, 1379288194u, 4225182569u, 3667516477u, 1709989541u, 2725013602u, 3639843023u,
    2470483982u, 877580602u, 3981838403u, 3762572073u, 1129162571u, 732225574u, 3232041815u, 1652884780u, 2227121257u,
    1426140634u, 1386256573u, 24035717u, 1598686658u, 3146815575u, 739944537u, 579625482u, 3903349120u, 389846205u,
    2834153464u, 1481069623u, 3740748788u, 3388062747u, 1020177209u, 734239551u, 2610427744u, 49703572u, 1416453607u,
    2815915291u, 937074653u, 3035635454u, 3711259084u, 2627383582u, 3669691805u, 263366740u, 3565059103u, 1190977418u,
    2747519432u, 4129538640u, 2271095827u, 2993032712u, 795918276u, 1116991810u, 937372240u, 1343017609u, 1166522068u,
    1623631848u, 2721658101u, 1937681565u, 114616703u, 954762543u, 1756889687u, 2936126607u, 2483004780u, 1927385370u,
    1672737098u, 2148675559u, 2636210123u, 1338083267u, 1335160250u, 2084630531u, 2746885618u, 636616055u, 2076016059u,
    408721884u, 2301682622u, 2691859523u, 2614088922u, 1975527044u, 3529473373u, 1490330107u, 4271796078u, 1910401882u,
    3738454258u, 2554452696u, 2237827073u, 2803250686u, 1996680960u, 839529273u, 3544595875u, 3909443124u, 3656063205u,
    837475154u, 438095290u, 484603494u, 308425103u, 268427550u, 4243643405u, 2849988118u, 2948254999u, 2102063419u,
    1735616066u, 1539151988u, 95237878u, 2005032160u, 1433635018u, 116647396u, 881378302u, 2159170082u, 336034862u,
    2017579106u, 944743644u, 1694443528u, 260177668u, 505662155u, 3722741628u, 1511077569u, 1103819072u, 2089123665u,
    2475035432u, 1120017626u, 2842141483u, 4029205195u, 3873078673u, 136118734u, 1699452298u, 1403506686u, 1805475756u,
    2562064338u, 4271866024u, 3071338162u, 459509140u, 771592405u, 185232757u, 4032960199u, 3512945009u, 308584855u,
    4250142168u, 2565680167u, 38924274u, 3770488806u, 3099963860u, 1255084262u, 2363435042u, 54945052u, 2534883189u,
    2432427547u, 2741583197u, 1280920000u, 1281043691u, 1121403845u, 2127558730u, 713121337u, 2108187161u, 927011680u,
    4134691985u, 1958963937u, 2567532373u, 4075249328u, 4104757832u, 3026358429u, 3573008472u, 3615577014u, 1541946015u,
    3087190425u, 857839960u, 2515339233u, 2809830736u, 460237542u, 1950698961u, 2069753399u, 1106466069u, 356742959u,
    3662626864u, 1750561299u, 992181339u, 3384018814u, 100741310u, 451656820u, 3650357479u, 2390172694u, 2088767754u,
    164402616u, 2751052984u, 1767810825u, 3441135892u, 3323383489u, 2756998822u, 207428029u, 2648427775u, 2360400900u,
    1396468647u, 1377764574u, 1435134775u, 1099809675u, 3374512975u, 3542220540u, 4081637863u, 337070226u, 644850146u,
    1306761320u, 1242645122u, 4109252858u, 3377483696u, 1788337208u, 1658628529u, 2911512007u, 367022558u, 3071359622u,
    4273132307u, 3898950547u, 1858986613u, 2040551642u, 4077477194u, 3565689036u, 265993036u, 1864569342u, 923017956u,
    490608221u, 3833372385u, 3287246572u, 2649450292u, 500120236u, 2810524030u, 1561519055u, 3224066062u, 2774151984u,
    2107011431u, 96459446u, 1235983679u, 4237425634u, 276949224u, 4100839753u, 427484362u, 4246879223u, 1858777639u,
    3476334357u, 358032121u, 2511026735u, 1535473864u, 556796152u, 1476438092u, 2913077464u, 3051522276u, 4046477658u,
    1802040304u, 990407433u, 4052924496u, 2926590471u, 4265214507u, 82077489u, 464407878u, 4190838199u, 733509243u,
    1583801700u, 1877837196u, 3912423882u, 8759461u, 2540185277u, 2019419351u, 4051584612u, 700836153u, 1675560450u,
    3130433948u, 405251683u, 2224044848u, 4071581802u, 2272418128u, 803575837u, 4019147902u, 3841480082u, 3424361375u,
    779434428u, 3057021940u, 2285701422u, 1783152480u, 823305654u, 3032187389u, 4159715581u, 3420960112u, 3198900547u,
    3006227299u, 4194096960u, 1775955687u, 1719108984u, 684087286u, 531310503u, 3105682208u, 3382290593u, 777173623u,
    3241407531u, 2649684057u, 1397502982u, 3193669211u, 811750340u, 3403136990u, 2540585554u, 784952939u, 943914610u,
    3985088434u, 1911188923u, 519948041u, 3181425568u, 1089679033u, 240953857u, 3017658263u, 3828377737u, 308018483u,
    4262383425u, 3188015819u, 4051263539u, 4074952232u, 1683612329u, 206775997u, 2283918569u, 2217060665u, 350160869u,
    140980u, 1891558063u, 422986366u, 330624974u, 918718096u, 376390582u, 3424344721u, 3187805406u, 3855037968u,
    1928519266u, 3059200728u, 2108753646u, 1343511943u, 2247006571u, 622521957u, 917121602u, 3299763344u, 2864033668u,
    2661022773u, 2006922227u, 1237256330u, 3449066284u, 3285899651u, 786322314u, 1244759631u, 3263135197u, 987586766u,
    3206261120u, 1827135136u, 1781944746u, 2482286699u, 1109175923u, 4190721328u, 1129462471u, 1623777358u, 3389003793u,
    1646071378u, 1164309901u, 989577914u, 3626554867u, 1516846461u, 3656006011u, 3698796465u, 3155218919u, 1237411891u,
    1854985978u, 3939149151u, 878608872u, 2437686324u, 3163786257u, 1235300371u, 1256485167u, 1883344352u, 2083771672u,
    3066325351u, 2770847216u, 601221482u, 3992583643u, 2557027816u, 900741486u, 90375300u, 300318232u, 3253901179u,
    542270815u, 1273768482u, 1216399252u, 325675502u, 3652676161u, 1097584090u, 3262252593u, 3704419305u, 411263051u,
    3460621305u, 1967599860u, 901109753u, 2682611693u, 797089608u, 3286110054u, 2219863904u, 3623364733u, 3061255808u,
    1615375832u, 2701956286u, 4145497671u, 449740816u, 2686506989u, 1235084019u, 2151665147u, 2091754612u, 1178454681u,
    3213794286u, 2601416506u, 4004834921u, 238887261u, 186020771u, 2367569534u, 1962659444u, 3539886328u, 2144472852u,
    1390394371u, 3597555910u, 3188438773u, 3371014971u, 2058751609u, 1169588594u, 857915866u, 923161569u, 4068653043u,
    3808667664u, 581227317u, 2077539039u, 851579036u, 2794103714u, 2094375930u, 3122317317u, 2365436865u, 2023960931u,
    2312244996u, 612094988u, 1555465129u, 3306195841u, 1702313921u, 1171351291u, 2043136409u, 3744621107u, 1028502697u,
    6114625u, 3359104346u, 1024572712u, 1927582962u, 3392622118u, 1347167673u, 2075035198u, 4202817168u, 701024148u,
    1481965992u, 1334816273u, 2870251538u, 1010064531u, 713520765u, 4089081247u, 3231042924u, 2452539325u, 1343734533u,
    587001593u, 1917607088u, 3498936874u, 246692543u, 2836854664u, 2317249321u, 774652981u, 1285694082u, 397012087u,
    1717527689u, 2904461070u, 3893453420u, 1565179401u, 600903026u, 1134342772u, 3234226304u, 345572299u, 2274770442u,
    1079209397u, 2122849632u, 1242840526u, 3987000643u, 3065138774u, 3111336863u, 1023721001u, 3763083325u, 2196937373u,
    2643841788u, 4201389782u, 4223278891u, 292733931u, 1424229089u, 2927147928u, 1048291071u, 2490333812u, 4098360768u,
    3948800722u, 335456628u, 540133451u, 3313113759u, 3430536378u, 2514123129u, 2418881542u, 487365389u, 1136054817u,
    3004241477u, 4109233936u, 3679809321u, 3527024461u, 1147434678u, 3308746763u, 1875093248u, 4217929592u, 400784472u,
    160353261u, 2413172925u, 1853298225u, 3201741245u, 3680311316u, 4274382900u, 1131020455u, 194781179u, 3440090658u,
    2165746386u, 3106421434u, 880320527u, 1429837716u, 252230074u, 3623657004u, 3869801679u, 2507199021u, 1659221866u,
    3121647246u, 3884308578u, 2610217849u, 641564641u, 329123979u, 121860586u, 947795261u, 1992594155u, 3050771207u,
    2767035539u, 627269409u, 1806905031u, 584050483u, 4142579188u, 3259749808u, 644172091u, 3053081915u, 2840648309u,
    2244943480u, 4057483496u, 873421687u, 2447660175u, 1233635843u, 2163464207u, 2515400215u, 3100476924u, 470325051u,
    2598261204u, 850667549u, 3622479237u, 2781907007u, 943739431u, 1901484772u, 939810041u, 3261383939u, 2212130277u,
    3349254805u, 2796552902u, 3372846298u, 3835884044u, 2764936304u, 1338171648u, 2525665319u, 4196233786u, 2290169528u,
    1793910997u, 1554419340u, 1733094688u, 1084699349u, 3233936866u, 1428704144u, 3269904970u, 3347011944u, 1892898231u,
    1072588531u, 3547435717u, 1593338562u, 919414554u, 3953006207u, 877438080u, 224271045u, 2914958001u, 2920583824u,
    1251814062u, 385182008u, 640855184u, 4263183176u, 3041193150u, 3505072908u, 2830570613u, 1949847968u, 2999344380u,
    1714496583u, 15918244u, 2605688266u, 3253705097u, 4152736859u, 2097020806u, 2122199776u, 1069285218u, 670591796u,
    768977505u, 379861934u, 1557579480u, 547346027u, 388559045u, 1495176194u, 4093461535u, 1911655402u, 1053371241u,
    3717104621u, 1144474110u, 4166253320u, 2747410691u
};

// returns current time in nanoseconds
uint64_t get_time()
{
    struct timespec t;
    clock_gettime(CLOCK_PROCESS_CPUTIME_ID, &t);
    return (((uint64_t)t.tv_sec * 1000000000) + (uint64_t)t.tv_nsec);
}

// Initialize data to pseudorandom values.
void data_setup()
{
    static const uint64_t k0 = 0xc3a5c85c97cb3127ULL;
    uint64_t a = 9;
    uint64_t b = 777;
    for (int i = 0; i < k_data_size; i++)
    {
        a += b;
        b += a;
        a = (a ^ (a >> 41)) * k0;
        b = (b ^ (b >> 41)) * k0 + i;
        uint8_t u = b >> 37;
        memcpy(data + i, &u, 1);  // uint8_t -> char
    }
}

int check(uint32_t actual, int index)
{
    int errors = 0;
    const uint32_t e = farmhash64_expected[index];
    if (actual != e)
    {
        fprintf(stderr, "%s : expected %uu but got %uu\n", __func__, e, actual);
        ++errors;
    }
    return errors;
}

int test_data_item64(int offset, int len, int index)
{
    int errors = 0;
    uint64_t h = farmhash64(data + offset, len);
    errors += check((uint32_t)(h >> 32), index);
    errors += check((uint32_t)((h << 32) >> 32), index+1);
    return errors;
}

int test_farmhash64()
{
    int i = 0;
    int errors = 0;
    data_setup();
    int index = 0;
    for ( ; i < k_test_size - 1; i++)
    {
        errors += test_data_item64(i * i, i, index);
        index += 2;
    }
    for ( ; i < k_data_size; i += i / 7)
    {
        errors += test_data_item64(0, i, index);
        index += 2;
    }
    errors += test_data_item64(0, k_data_size, index);
    return errors;
}

int test_farmhash64_strings()
{
    int errors = 0;
    uint64_t h;
    int i;
    for (i=0 ; i < TEST_STRING_DATA_SIZE; i++)
    {
        h = farmhash64(string_input[i].str, strlen(string_input[i].str));
        if (h != string_input[i].h64)
        {
            fprintf(stderr, "%s (%d) expected %lx but got %lx for %s\n", __func__, i, string_input[i].h64, h, string_input[i].str);
            ++errors;
        }
    }
    return errors;
}

void benchmark_farmhash64()
{
    uint64_t tstart, tend;
    int i;
    int size = 100000;
    tstart = get_time();
    for (i=0 ; i < size; i++)
    {
        farmhash64("123456789012345", 15);
        farmhash64("1234567890123456789012345678901", 31);
        farmhash64("123456789012345678901234567890123456789012345678901234567890123", 63);
        farmhash64("1234567890123456789012345678901234567890123456789012345678901234567890", 70);
    }
    tend = get_time();
    fprintf(stdout, " * %s : %lu ns/op\n", __func__, (tend - tstart)/(size*4));
}

int test_farmhash32_strings()
{
    int errors = 0;
    uint32_t h;
    int i;
    for (i=0 ; i < TEST_STRING_DATA_SIZE; i++)
    {
        h = farmhash32(string_input[i].str, strlen(string_input[i].str));
        if (h != string_input[i].h32)
        {
            fprintf(stderr, "%s (%d) expected %x but got %x for %s\n", __func__, i, string_input[i].h32, h, string_input[i].str);
            ++errors;
        }
    }
    return errors;
}

int main()
{
    int errors = 0;

    errors += test_farmhash64_strings();
    errors += test_farmhash64();
    errors += test_farmhash32_strings();

    benchmark_farmhash64();

    return errors;
}
